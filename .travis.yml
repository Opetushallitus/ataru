dist: xenial
language: java
jdk:
  - openjdk11
sudo: required
services:
  - docker
env:
  global:
    # AWS_ACCESS_KEY_ID
    - secure: "Ct/S7znCDJhmG7dvQxifdeqzUCe+MH8o/iMQLSwi+8NaE/xnSJLg9PzpHdaDm4zC5XQI8hNlFmaP/b2UuDoWdgwk+S3GUXd1Y4zCcyS5O7hW+DnI8xjJ5JGIS3R6J67dZfhkWRBr36UbAgWv+KxGIJ1wjZlGyY7SdnaUYr1H+pCfI90jMiJ8FK9EoSw2GXKnk+RQR1Gwup9b5xsMhWhCubGQiRPPQi7KpdU4JwvPF69LoXozCbj4VsvGx1kNsobEVPiwt/V53T3gOyK4E4XTnbyAvVNMQDBjwFUToGxA8LjHIKiVL/BPcu7oSXPeZLO2JLSCIAOUi6aDAvvzPu5xA59lqIgt2rLnF2I+81xngejn0hpeuOktdFVXKVz6WGBv/7lASJxV9FI73yTk9fN6/FztKEkeV8h8DN01Atab3sWoHPTqY5VEhRAm9C5eGbE1WDv1qTogNoyUwBR01Qv4JTo2Lh9BjGu5gsu7t5epF2+ArHEvpRxklTWDjKdPuiPFSy1HucHLSgea3Bm8Xs/Vl2NsUlD7ZFnNJQy6vcFl58JUD4u2GilfBQcvNRs2c3BlEA5Vk5/uuFpl2up+3kyLXqQvX9hKUM8q1BbpvlzVjGqQ09IahNfm8Ufi+sxQeIrTxK84ukEIlj8wOq8rgJh+ta7NQU8iSS+96rum4rjXJ9o="
    # AWS_SECRET_ACCESS_KEY
    - secure: "la8MQBP3bIr9jyqOk9J9Zyhujx6kCojngJFbe7iPRFfhXrK6tHzejnXuprGPyB9gvKocLzYxFGoOFeT5YTVM5kv0P6j7zpqhBO6shIVzDGWiqThB4iAq2oTUn0LO/Rs3ByvEDmuyy7BeFa7JY6KiXK3F9gWnOGMyCw1bM1of130bD0eHaxh9jlPATZZFY/IPKCzxm6ABXhYeXhBalF4Qizuisbgw0FvlLo91BhAqZJDM6zha0ovOxF3BIzjkDuunVJcUzaLDHDwV6nTWxWMu2DRH5k6b4ut69vVBXzX9r9KhIezLWilyDkqg5jmQCUG5luqHonvOjhdG3qn3g+64dn0QAq5vqGu88Bt/uNpxyR8Y9erHK6ItlHzNvKfp/ZFRqu0PJLbHzFpRxmqjJpRz0H2e2Z0boxUrmxjhpoC2HbOKiqyFwsZqElHtTTfmZ9A44+7CdOXd3TSVNajamPuJIfhhjy1DdaCMOISGFH9vO3DPOysDe0oSeeeX9qUGEk/BohvSF8EYFGEm1h+zS2XxVLydINdgnvIHmeQ4+uAbs+yMN5t3yL4IaXPZI437lcRgnNEHxKubnujHJOlJbVKYRP9EH6jmQPbUVJVvIQE69Aq+UDQgw7vogTHjsNSzdXSKC+l0vjed8N1jyL3XiMZukH0Tp1RMckS3WkgPzL/Ewr0="
    # S3_ACCESS_KEY_ID
    - secure: "eQwWamCqm/PnpWkw8oJ8eUuq1yzQWVlDXTHXg+czLvmnmK9p2ZG1/AJGPTjYroyjZ7yvjswbC3cCqi7szWHyRvtMtzbKeU94B8n/IpEWdHvTUMM62Vp7Mibugy8sidEyaSmEvuPDZEVbv8SPEBqa/Iob47W6B/l0YMHo5KCkPDS3vQL0I6H/HzlSgLunu2+4vgB2Y4eH5Ns5MYV4G2rv9yKrtrhX+NSynH6/y7G54qvB67+eMXZbVgxtylz/yZA4oYVCkBz9U1EfjsKwiVXtolUHtTtVazkfZKiYb+/Ayo7cUE/LNeY93YOOVXkEiormsQ5SbCzGcjaR77iFQnk1uf1bY4C5AEWyilw1POaLrLty+oPsAkyWfqjNiozCWHitFYs+OvL+3BWY2E7yQ38WfzRk+eGNHmrEucm0UXxuror7fOSIe7qLVEhQmiI7H1LYBaepxSIHGN/l2A072Ng+FeT0M9H0NANgYW3/JYMMgqRJoSiRDNNQ2Rir5EkNp3kewRVa5LfN46fXH2nVHsVK0qXFDSTJ4J6HHBcr/uHtMe2wZL8bI9XUspK4fPr2GQznzr9OmKq5A8PioGFdKsUCo61NcULVN390X1dE4nAzJKZzxFpJKbaezX2kqEdoHZEWicpqg+mH/R/EeO8LfhmqC46Utzq20T4Smv44ZPee8OE="
    # S3_SECRET_ACCESS_KEY
    - secure: "PtylxpiDJjYWcsj1qNsT/p1lO5ZdzYjMrAQxo0W58cNvBM5KLSZ9JFIOROzxJuHHwU1uKNBcWJsEeZPnIFjXhUzxbnMjld/zdcPLTs40tA4XCJVmZr5RekyBhwau2xQj+PHXAau5hdDY8/VjWLXsn5W6Xf0JrLtvkqi+rQAt5MjPhLB88FaWd/aQPqEeTF4j+eqjLgdfs8/fNfTEkJbyvWiRRwUT36EpJ4yvJvPSRYcDOlxfyzS3tO4jpb4u31NYanEOKPxglzHNovjsGVponx8Zh95lkrRCm1SUwnTX7ioRabr2oldC7byyJwWYO6HbyXYaTztiRPIh/WH8z1Q3xkEHBcaJdVtD6dQoTn+Mq7fKSSxWWoUIXTpCF4ACdVOhHxbLOuHtRxLcqb8nRYnE9avzTL2LAPtDHIPdcEbNnFSLXfpJ0z8oBwutKr9TJpzb9aIzjeiXLUqGefAbILQHA8hSC5x7F03fp3fvI+mn3SZLShEu1D7deWoQfbv6TfB09dtIZKDV84vk07rXJOHRdzxyOrbE7rpv2ijaspquwZqIk4MNsOHhKy2VNryAnLdURDIwzqN9bgUNrrky5kXvFCfd2YHscF9iqSvod+kN2cEy1ClF1asZcxUmMEOlm2e65Xlgn/HC/4GTRW+90FjTEe94Y6qD6HtYeDYdk00nt+Y="
cache:
  directories:
    - $HOME/.m2
before_install:
  - sudo apt-get update
  - sudo apt-get install -y lftp
install:
  - git clone https://github.com/Opetushallitus/ci-tools.git
  - source ci-tools/common/setup-tools.sh
before_script:
  - docker run -d --name ataru-test-db -p 5433:5432 -e POSTGRES_DB=ataru-test -e POSTGRES_PASSWORD=oph -e POSTGRES_USER=oph 190073735177.dkr.ecr.eu-west-1.amazonaws.com/utility/hiekkalaatikko:ataru-test-postgres
  - docker run -d --name ataru-test-redis -p 6380:6379 redis
  - docker run -d --name ataru-test-ftpd -p 2221:21 -p 30000-30009:30000-30009 190073735177.dkr.ecr.eu-west-1.amazonaws.com/utility/hiekkalaatikko:ataru-test-ftpd
script: >-
  ./bin/cibuild.sh run-tests-and-create-uberjar &&
  export BASE_IMAGE="baseimage-fatjar:jdk11" &&
  ./ci-tools/common/pull-image.sh &&
  cp -v ./target/ataru.jar $DOCKER_BUILD_DIR/artifact/ataru-editori.jar &&
  cp -vr ./oph-configuration $DOCKER_BUILD_DIR/config/ &&
  ./ci-tools/build/build-fatjar.sh ataru-editori &&
  ./ci-tools/common/clean-docker-build-dir.sh &&
  cp -v ./target/ataru.jar $DOCKER_BUILD_DIR/artifact/ataru-hakija.jar &&
  cp -vr ./oph-configuration $DOCKER_BUILD_DIR/config/ &&
  ./ci-tools/build/build-fatjar.sh ataru-hakija
deploy:
  provider: script
  script: >-
    ./ci-tools/build/upload-image.sh ataru-editori &&
    ./ci-tools/build/upload-image.sh ataru-hakija
  on:
    all_branches: true
